name: Main

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  windows:
    runs-on: windows-2022
    steps:
      # Set up caching
      - name: Set up Cabal cache
        uses: actions/cache@v4
        with:
          path: |
            C:\cabal\packages
            C:\cabal\store
            dist-newstyle
          key: windows-cabal-${{ hashFiles('cabal.project') }}-${{ hashFiles('**/*.cabal') }}
      - name: Set up Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~\.cargo\bin
            ~\.cargo\registry\index
            ~\.cargo\registry\cache
            ~\.cargo\git\db
            target
          key: windows-cargo-${{ hashFiles('opensolid-jit/Cargo.*') }}
      # Build and test
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        run: |
          rustup install 1.80.1-x86_64-pc-windows-gnu
          rustup default 1.80.1-x86_64-pc-windows-gnu
      - name: Build opensolid-jit library
        run: cargo build --release
        working-directory: opensolid-jit
      - name: Add opensolid-jit build directory to PATH
        run: echo "PATH=$env:PATH;$env:GITHUB_WORKSPACE\opensolid-jit\target\release" >> $env:GITHUB_ENV
      - name: Build Haskell libraries
        run: |
          cabal update
          cabal build all
      - name: Run sandbox
        run: cabal run sandbox
      - name: Run tests
        run: cabal test opensolid
      - name: Copy opensolid-ffi.dll to opensolid-python/opensolid directory
        run: Get-ChildItem -Path dist-newstyle -Filter opensolid-ffi.dll -Recurse | Copy-Item -Destination .\opensolid-python\opensolid\
      - name: Generate Python library code
        run: cabal run opensolid-python # | Set-Content -Path .\opensolid-python\opensolid\__init__.py
      # - name: Try evaluating a Python expression
      #   run: |
      #     cd opensolid-python
      #     python -c "from opensolid import *; print(Point2f.x(3).distance_to(Point2f.y(4)))"

# jobs:
#   test:
#     runs-on: ${{ matrix.os }}
#     strategy:
#       matrix:
#         include:
#           # - os: ubuntu-latest
#           #   rust-target: x86_64-unknown-linux-gnu
#           - os: windows-2022
#             # Use MinGW instead of MSVC on Windows,
#             # for compatibility with Haskell compiler
#             # which is MinGW-based
#             rust-target: x86_64-pc-windows-gnu
#           # - os: macos-13
#           #   rust-target: x86_64-apple-darwin
#           # - os: macos-latest
#           #   rust-target: aarch64-apple-darwin
#     steps:
#       - uses: actions/checkout@v4
#       # Cache built Haskell dependencies
#       - uses: actions/cache@v4
#         name: Cache ~/.stack
#         with:
#           path: ~/.stack
#           key: ${{ matrix.os }}-stack-${{ hashFiles('stack.yaml') }}-${{ hashFiles('**/*.cabal') }}
#           restore-keys: ${{ matrix.os }}-stack
#       # Install Rust toolchain
#       - uses: dtolnay/rust-toolchain@master
#         with:
#           toolchain: 1.80.1-${{ matrix.rust-target }}
#       # Install Haskell toolchain
#       # - uses: haskell-actions/setup@v2
#       #   with:
#       #     enable-stack: true
#       #     ghc-version: 9.6.6
#       #     stack-version: 3.1.1
#       # Configure LIBRARY_PATH on Windows
#       - if: runner.os == 'Windows'
#         run: echo "LIBRARY_PATH=$env:GITHUB_WORKSPACE\\opensolid-jit\\target\\release" >> $GITHUB_ENV
#       # Build opensolid_jit library
#       - run: cargo build --release
#         working-directory: opensolid-jit
#       - name: Store built opensolid-jit binaries
#         uses: actions/upload-artifact@v4
#         with:
#           name: opensolid-jit-binaries-${{ matrix.os }}
#           path: opensolid-jit
#       # Build and test Haskell libraries
#       - run: stack build
#       - run: stack test
