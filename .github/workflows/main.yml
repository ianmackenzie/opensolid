name: Main

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  windows:
    runs-on: windows-2022
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set STACK_ROOT environment variable
        run: Add-Content -Path $env:GITHUB_ENV -Value 'STACK_ROOT=${{ github.workspace }}\stack_root'
      - name: Set up Stack cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}\stack_root
          key: windows-stack-${{ hashFiles('stack.yaml') }}-${{ hashFiles('**/*.cabal') }}
          restore-keys: windows-stack
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          # Use MinGW instead of MSVC version,
          # for compatibility with GHC
          toolchain: 1.80.1-x86_64-pc-windows-gnu
      - name: Build opensolid-jit library
        run: cargo build --release
        working-directory: opensolid-jit
      - name: Build Haskell libraries
        run: stack --resolver nightly-2024-11-19 build --only-dependencies opensolid

      # echo "LIBRARY_PATH=$env:GITHUB_WORKSPACE\\opensolid-jit\\target\\release" >> $env:GITHUB_ENV
# jobs:
#   test:
#     runs-on: ${{ matrix.os }}
#     strategy:
#       matrix:
#         include:
#           # - os: ubuntu-latest
#           #   rust-target: x86_64-unknown-linux-gnu
#           - os: windows-2022
#             # Use MinGW instead of MSVC on Windows,
#             # for compatibility with Haskell compiler
#             # which is MinGW-based
#             rust-target: x86_64-pc-windows-gnu
#           # - os: macos-13
#           #   rust-target: x86_64-apple-darwin
#           # - os: macos-latest
#           #   rust-target: aarch64-apple-darwin
#     steps:
#       - uses: actions/checkout@v4
#       # Cache built Haskell dependencies
#       - uses: actions/cache@v4
#         name: Cache ~/.stack
#         with:
#           path: ~/.stack
#           key: ${{ matrix.os }}-stack-${{ hashFiles('stack.yaml') }}-${{ hashFiles('**/*.cabal') }}
#           restore-keys: ${{ matrix.os }}-stack
#       # Install Rust toolchain
#       - uses: dtolnay/rust-toolchain@master
#         with:
#           toolchain: 1.80.1-${{ matrix.rust-target }}
#       # Install Haskell toolchain
#       # - uses: haskell-actions/setup@v2
#       #   with:
#       #     enable-stack: true
#       #     ghc-version: 9.6.6
#       #     stack-version: 3.1.1
#       # Configure LIBRARY_PATH on Windows
#       - if: runner.os == 'Windows'
#         run: echo "LIBRARY_PATH=$env:GITHUB_WORKSPACE\\opensolid-jit\\target\\release" >> $GITHUB_ENV
#       # Build opensolid_jit library
#       - run: cargo build --release
#         working-directory: opensolid-jit
#       - name: Store built opensolid-jit binaries
#         uses: actions/upload-artifact@v4
#         with:
#           name: opensolid-jit-binaries-${{ matrix.os }}
#           path: opensolid-jit
#       # Build and test Haskell libraries
#       - run: stack build
#       - run: stack test
